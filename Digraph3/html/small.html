<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8">
  <title>
    Small Graph Template
  </title>
  <script src="http://leopold-loewenheim.uni.lu/WWWgary/js/d3.v3.js"></script>
  <style>
  path.link {
    fill: none;
    cursor: pointer;
    stroke: #000;
    stroke-width: 2px;
    }
  .node circle {
    cursor: pointer;
    stroke: white;
    stroke-width: 1.0px;
    } 
  text {
    fill: #000;
    font: 12px sans-serif;
    pointer-events: none;
    text-anchor: middle;
  }
  </style>
</head>

<body>
  <script>
  d3.json("dataset.json", function(error, links) {
  /*
   *
   *  Functions
   *
   */
  var linkedByIndex = {};
  var focusNode = function(d) {
    var circle = d3.select();
    links.links.forEach(
      function(d) {
        linkedByIndex[d.source.index + "," + d.target.index] = true;
    });
    node
      .transition(500)
      .style("opacity", 
        function(o) {
          return isConnected(o, d) || isEqual(o,d) ? 1.0 : 0.2 ;
        })
      .style("fill", 
        function(o) {
          if (isConnected(o, d)) {
              fillcolor = "orange";
          }      
          else if(isEqual(o,d)) {
            fillcolor = "red";
          }
          else {
            fillcolor ="#000"
          }
          return fillcolor;
        }); 
    path
      .transition(500)
      .style("stroke-opacity", 
        function(o) {
          return o.source === d || o.target === d ? 1 : 0.2;
        })
      .transition(500)
      .style("opacity", 
        function(o) {
          return o.source === d || o.target === d ? 1 : 0.2;
        });
    circle
      .transition(500);
    labels
      .transition(500)
      .style("opacity", 
        function(o) {
          return o.source === d || o.target === d ? 1 : 0;
        });
  }

  function isConnected(a, b) {
    return linkedByIndex[b.index + "," + a.index] || linkedByIndex[a.index + "," + b.index];
  }
  function isEqual(a, b) {
    return a.index == b.index;
  }
  
  
  
  function tick() {
    labels
      .attr("x", function(d) { return (d.source.x + d.target.x) / 2; }) 
      .attr("y", function(d) { return (d.source.y + d.target.y) / 2; }) 
    path
      .attr("d", 
        function(d) {
          var dx = d.target.x - d.source.x,
          dy = d.target.y - d.source.y,
          dr = Math.sqrt(dx * dx + dy * dy);
          return "M" + 
            d.source.x + "," + 
            d.source.y + "A" + 
            dr + "," + dr + " 0 0,1 " + 
            d.target.x + "," + 
            d.target.y;
        });
    node
      .attr("transform", 
        function(d) {
          return "translate(" + d.x + "," + d.y + ")"; 
        });  
  }

  /*
   *
   *  Graph
   *
   */

  var nodes = links.nodes;
  var width = window.innerWidth,
    height = window.innerHeight;
  var force = d3.layout.force()
    .nodes(d3.values(nodes))
    .links(links.links)
    .size([width, height])
    .linkDistance(150)
    .charge(-3000)
    .on("tick", tick)
    .friction(0.6)
    .gravity(0.6)
    .start();

  var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);
  svg.append("svg:defs").selectAll("marker")
    .data(["end-full"])
    .enter().append("svg:marker")
    .attr("id", String)
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", 23)
    .attr("refY", -0.6)
    .attr("markerWidth", 6)
    .attr("markerHeight", 6)
    .attr("orient", "auto")
    .append("svg:path")
    .attr("d", "M0,-5L10,0L0,5z");
  svg.append("svg:defs").selectAll("marker")
    .data(["end-empty"])
    .enter().append("svg:marker")
    .attr("id", String)
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", 23)
    .attr("refY", -0.6)
    .attr("markerWidth", 6)
    .attr("markerHeight", 6)
    .attr("orient", "auto")
    .append("svg:path")
    .attr("stroke", "black")  .attr("fill", "white")  .attr("stroke-width", 2)  .attr("d", "M0,-5L10,0L0,5z");
  svg.append("svg:defs").selectAll("marker")
    .data(["start-full"])
    .enter().append("svg:marker")
    .attr("id", String)
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", -13)
    .attr("refY", -0.6)
    .attr("markerWidth", 6)
    .attr("markerHeight", 6)
    .attr("orient", "auto")
    .append("svg:path")
    .attr("d", "M10,-5L0,0L10,5z");
  svg.append("svg:defs").selectAll("marker")
    .data(["start-empty"])
    .enter().append("svg:marker")
    .attr("id", String)
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", -13)
    .attr("refY", -0.6)
    .attr("markerWidth", 6)
    .attr("markerHeight", 6)
    .attr("orient", "auto")
    .append("svg:path")
    .attr("stroke", "black")  
    .attr("fill", "white")  
    .attr("stroke-width", 2)  
    .attr("d", "M10,-5L0,0L10,5z");
  var path = svg.append("svg:g").selectAll("path")
    .data(force.links())
    .enter().append("svg:path")
    .attr("class", function(d) { return "link " + d.type; })
    .attr("class", "link")
    .attr("stroke-dasharray", function(d) { if(d.type == 5 || d.type ==6|| d.type ==7) return "3,3";})
    .attr("marker-end", 
      function(d) { 
        if(d.type == 4 || d.type ==6|| d.type ==7) 
          return "url(#end-empty)"; 
        if(d.type == 0 || d.type ==2|| d.type ==3) 
          return "url(#end-full)";})
    .attr("marker-start", 
      function(d) { 
        if(d.type == 3|| d.type ==5|| d.type ==7) 
          return "url(#start-empty)"; 
        if(d.type == 1 || d.type ==2|| d.type ==4) 
          return "url(#start-full)";
      });

  var labels = svg.selectAll('text')
    .data(links.links)
    .enter().append('text')
    .attr("x", function(d) { return (d.source.y + d.target.y) / 2; }) 
    .attr("y", function(d) { return (d.source.x + d.target.x) / 2; }) 
    .attr("text-anchor", "middle") 
    .text(function(d) {return d.type;}); 



  var node = svg.selectAll(".node")
    .data(links.nodes)
    .enter().append("g")
    .attr("class", "node")
    .style("fill","orange")
    .call(force.drag);

  node.append("circle")
    .attr("r", 15)
    .on("click", focusNode)
    .on("dblclick", 
      function(d) { 
        alert("Name: " + d.name + "\nComment: "+ d.comment); 
      });

  node.append("text")
    .attr("x", 0)
    .attr("dy", ".35em")
    .text(function(d) { return d.name; });

  });
  </script>
</body>
</html>
